<!DOCTYPE html>
<html>
<!--
    file:///home/smhanov/fun/blorb.html#fileid=mXOJAJ4ny3RqsjvXK3kx0ZLXsg4
-->
<head>
    <meta charset="utf-8">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link href='//fonts.googleapis.com/css?family=Special+Elite' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Love+Ya+Like+A+Sister' rel='stylesheet' type='text/css'>
    <link href='./Zwibbler.css' rel='stylesheet' type='text/css'>
</head>
<body>
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>    
    <script src="../zwibbler.js"></script>
    <zwibbler z-controller="mycontroller"
        autoPickTool="true"
        showToolbar="false",
        defaultPaperSize="letter"
        pageView="true",
        defaultFontSize="50",
        defaultFont="Bitter",
        multilineText="true",
        defaultLineWidth="0",
        showColourPanel="false"
        >

        
        <div id=pages class="blue noselect">
            <div class="logo">
                <img src="../images/logo.png" />
            </div>
            <div class="page-count">페이지 1</div>
            <div class=page-buttons>
                <button title="add-page" z-click="setCurrentPage(insertPage(getCurrentPage()+1))">
                    <i class="fa fa-plus"></i></button>
                <button title="delete-page" z-click="deletePage(getCurrentPage())">
                    <i class="fa fa-minus"></i></button>
            </div>
            <div z-sort="movePage($from, $to)" class="page-content">
                <div z-for="page in getPageCount()"
                     draggable="TRUE"
                     z-sortable
                     z-selected="page==getCurrentPage()"
                     z-page="page"
                     z-click="setCurrentPage(page)"
                     z-width="140">
                </div>
            </div>
        </div>
        <div class="top-bar">
            <div class="top-bar-left">
                <button><a href="javascript:history.back()"> <img src="../images/home.png" /></a> </button>
                <button class="download-pdf"title="Download PDF" z-click="download('pdf', 'blerb.pdf')" > 내보내기</button>
            </div>
            <div class="top-bar-center">
                <!-- <button z-click='ctx.setConfig("snap", 20)'>Enable snap</button>
                <button z-click='ctx.setConfig("background", "grid")'>Enable grid</button> -->
                <button z-click="ctx.alignNodes('left')"><img src="../images/align-left.png" /></button>
                <button z-click="ctx.alignNodes('centre')"><img src="../images/align-center.png" /></button>
                <button z-click="ctx.alignNodes('right')"><img src="../images/align-right.png" /></button>
                <button z-click="ctx.alignNodes('top')"><img src="../images/align-top.png" /></button>
                <button z-click="ctx.alignNodes('middle')"><img src="../images/align-middle.png" /></button> 
                <button z-click="ctx.alignNodes('bottom')"><img src="../images/align-bottom.png" /></button>
            </div>
            <div class="top-bar-right">
                <button> 210mm x 297mm</button>
                <button > 100%</button>
            </div>
        </div>
        <z-canvas></z-canvas>

        <div id=side-menu class="blue noselect">
           
            <div class=tools>
                <button title="Pick tool" z-click="usePickTool()"><img src="../images/select_btn.png" /></button>
                <button class="Square" title="Square" z-click="useRectangleTool()"><img src="../images/square_draw_btn.png" /></button>
                <!-- <button title="Insert image" z-click="insertImage()"><i class="fa fa-file-image-o"></i></button> -->
                
            </div>
            <div class="transform" >
                <div class="transform-title" >트랜스폼</div>
                <div class="transform-axis">
                    <div class="transform-X-axis"><span>X</span><input type="text"/></div>
                    <div class="transform-Y-axis"><span>Y</span><input type="text"/></div>
                    <div class="transform-width"><span>W</span><input type="text"/></div>
                    <div class="transform-height"><span>H</span><input type="text"/></div>
                </div>
            </div>
            <div class="sections">
                <div class="section-title">
                등록완료
                </div>
                <div class="section-list">
                    <div class="section-list-header">
                        <div class="section-list-title">제목</div>
                        <div class="section-list-number">고유번호</div>
                    </div>
                    <div class="section-list-body">
                        <div class="section-list-title"><input type="text" value="1"/></div>
                        <div class="section-list-number"><input type="text" value="1234567890"/></div>
                        <div class="section-list-link"><img src="../images/link.png" /></div>
                        <div class="section-list-trash"><img src="../images/trash.png" /></div>
                    </div>
                </div>
            </div>
            <!-- <div class=tools-small style="margin-top:20px">
                <button title="Cut" z-click="cut()"><i class="fa fa-cut"></i></button>
                <button title="Copy" z-click="copy()"><i class="fa fa-copy"></i></button>
                <button title="Paste" z-click="paste()"><i class="fa fa-paste"></i></button>
                <button title="undo" z-click="undo()"><i class="fa fa-undo"></i></button>
                <button title="redo" z-click="redo()"><i class="fa fa-repeat"></i></button>
            </div> -->

            <!-- <div class=doc-buttons style="margin-top:20px">
                <button title="New" z-click="onNew()"><i class="fa fa-file-o"></i> New</button> 
                <button title="Save" z-click="onSaveDocument()"><i class="fa fa-cloud-upload"></i> Save</button>
            </div> -->
            <!-- <div class=doc-buttons>
                <button title="Collaborative editing" z-click="onShare()" style="width:192px"><i class="fa fa-share-square"></i> Edit with a friend</button>
                <button title="Download PDF" z-click="download('pdf', 'blerb.pdf')" style="width:192px"><i class="fa fa-file-pdf"></i> Download PDF</button> 
            </div>
            -->
            <!-- <div style="margin-top:20px" class="text-tools">
                <button title="Zoom" z-click="zoomIn()"><i class="fa fa-search"></i>  + </button>
                <button title="Zoom" z-click="zoomOut()"><i class="fa fa-search"></i>  - </button>
                <button z-has="shadow" title="Shadow" z-click='setNodeProperty(getSelectedNodes(), "shadow", !summary.properties.shadow)'><i
                    class="fa fa-glass" style="text-shadow: 3px 3px 3px #fff"></i>
                    Add shadow</button>
                <button z-has="fillStyle" title="Make transparent" z-click="onToggleTransparent()"><i
                    class="fa fa-glass" style="opacity:0.5"></i>  Make transparent</button>
                <button z-has="fontName" title="Font" z-click="onChangeFont()"><i
                    class="fa fa-font"></i>  Change font</button>
                <button z-has="fontSize" title="Inrease font size" z-click="onFontSize(1.1)"><i
                    class="fa fa-angle-up"></i>  Increase font size</button>
                <button z-has="fontSize" title="Decrease font size" z-click="onFontSize(1/1.1)"><i
                    class="fa fa-angle-down"></i>  Decrease font size</button> 
                <button z-has="textAlign" title="Text alignment" z-click="onTextAlign()"><i
                    class="fa fa-align-center"></i>  Text alignment</button>
            </div> -->
            <form style="display:none" method=post
                enctype="multipart/form-data"
                action="//zwibbler.com/temp.py">
                <input type=file name=file id=fileinput accept="image/*">
            </form>
        
        </div>
        
    </zwibbler>

    <script>
        function mycontroller(ctx) {
            //Zwibbler.enableConsoleLogging();
            ctx.onInsertImage = function() {
                $("#fileinput").click();
            };
            
            ctx.onNew = function() {
                if (!ctx.dirty() || confirm("Discard changes?")) {
                    ctx.newDocument();
                    location.hash = "";
                }
            };

            ctx.onShare = function() {
                var name = ctx.createSharedSession();
                var url = location.href;
                if (url.indexOf("#") >= 0) {
                    url = url.substr(0, url.indexOf("#"));
                }
                url += "#" + "session=" + name;
                prompt("Go to this URL in another browser to edit at the same time.",
                    url);
            };

            $("#fileinput").on("change", function(e) {
                var form = this.parentNode;
                ctx.upload(form).success(onUploadDone);
                form.reset();
            });

            var Zoom = "page";
            ctx.setZoom(Zoom);

            ctx.onZoom = function() {
                if (Zoom === "page") {
                    Zoom = "width";
                } else {
                    Zoom = "page";
                }
                ctx.setZoom(Zoom);
            };

            var Fonts = [
                "Special Elite",
                "Bitter",
                "Love Ya Like A Sister"
            ];

            // Add for PDF output
            Zwibbler.addFont("Bitter-Regular.ttf");
            Zwibbler.addFont("LoveYaLikeASister.ttf");
            Zwibbler.addFont("SpecialElite-Regular.ttf");

            ctx.onChangeFont = function() {
                let current = ctx.summary.properties.fontName;
                for(var i = 0; i < Fonts.length; i++ ) {
                    if ( current === Fonts[i] ) {
                        i += 1;
                        break;
                    }
                }

                var newFont = Fonts[i%Fonts.length];

                ctx.setNodeProperty(ctx.getSelectedNodes(), "fontName",
                    newFont);
            };

            ctx.onToggleTransparent = function() {
                var colour = Zwibbler.parseColour(ctx.summary.properties["fillStyle"]);
                if (colour.a === 1) {
                    colour.a = 0.7;
                } else {
                    colour.a = 1;
                }

                var newColourString = Zwibbler.makeColour(colour);

                ctx.setNodeProperty(ctx.getSelectedNodes(),
                    "fillStyle", newColourString);
            };

            ctx.onFontSize = function(factor) {
                var fontSize = ctx.summary.properties.fontSize;
                fontSize *= factor;
                ctx.setNodeProperty(ctx.getSelectedNodes(),
                    "fontSize", fontSize);
            };

            ctx.onTextAlign = function() {
                var TextAlign = ctx.summary.properties["textAlign"];
                if (TextAlign === "left") {
                    TextAlign = "center";
                } else if (TextAlign === "center") {
                    TextAlign = "right";
                } else {
                    TextAlign = "left";
                }

                ctx.setNodeProperty(ctx.getSelectedNodes(), "textAlign",
                    TextAlign);
            };

            // When the upload is done either successfully or due to an error, this
            // function is called. In the successful case, the status is set to
            // "ok". Otherwise it is set to an error message. The result contains
            // the JSON decoded response from the server. 
            // 
            // This function must then insert the image into the document.
            function onUploadDone(result, xhr) {
                // *******************************************************
                // *******************************************************
                // *******************************************************
                // CHANGE THIS CODE TO PROCESS YOUR OWN RESPONSE
                // *******************************************************
                // *******************************************************
                // *******************************************************
                result = JSON.parse(result);
                var url = "//zwibbler.com/temp.py?fileid=" +
                    result.fileid;

                ctx.beginTransaction();
                var nodeId = ctx.createNode("ImageNode", {
                    url: url
                });
                ctx.translateNode(nodeId, 100, 100);
                ctx.commitTransaction();
            }

            // ----------------------------------------------------------------
            // EXAMPLE CODE FOR SAVING THE DOCUMENT.
            ctx.onSaveDocument = function() {
                $.ajax({
                    url: "//zwibbler.com/temp.py",
                    type: "POST",
                    data: {file: ctx.save()},

                    success: function(response, status, xhr) {
                        $("#working").hide();
                        location.hash = "fileid=" + response.fileid;
                    },

                    error: function(response, status, xhr) {
                        $("#working").hide();
                        alert("Error: " + status);
                    }
                });
                $("#working").show();
            }

            // ----------------------------------------------------------------
            // EXAMPLE CODE FOR OPENING THE DOCUMENT
            function OpenDocument(fileid) {
                $.ajax({
                    url: "//zwibbler.com/temp.py",
                    type: "GET",
                    data: { fileid: fileid },

                    success: function(response, status, xhr) {
                        $("#working").hide();
                        ctx.load(response);
                    },

                    error: function(response, status, xhr) {
                        $("#working").hide();
                        alert("Error: " + status);
                    }
                });
                $("#working").show();
            }

            // ---------------------------------------------------------------
            // EXAMPLE CODE
            // When the page is loaded, and it contains a fileid= parameter,
            // then open that document.
            function SplitQueryString(string, separator) {
                var a, field, fields, i, index, key, value, _i, _len;
                separator = separator || "?";
                a = {};
                index = string.indexOf(separator);
                if (index >= 0) {
                    string = string.substr(index + 1);
                }
                index = string.indexOf('#');
                if (index >= 0) {
                    string = string.substr(0, index);
                }
                fields = string.split("&");
                for (_i = 0, _len = fields.length; _i < _len; _i++) {
                    field = fields[_i];
                    i = field.split("=");
                    key = decodeURIComponent(i[0]);
                    value = i.length > 1 ? decodeURIComponent(i[1]) : "";
                    if (key.length) {
                        a[key] = value;
                    }
                }
                return a;
            }

            var hash = SplitQueryString(location.hash, "#");
            if ("fileid" in hash) {
                OpenDocument(hash["fileid"]);
            } else if ("session" in hash) {
                ctx.joinSharedSession(hash["session"]);
            }
        }
        
    </script>
</body>
</html>
